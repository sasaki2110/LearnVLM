# valcheck ログ記録

速度検証スクリプト（`valcheck.py`）の実行結果を記録する。

---

## 検証目的

PyBulletから取得した速度と実際の位置変化から計算した速度が一致するかを検証する。
特に、動的状態（加速度が発生している状態）での速度取得の正確性を確認する。

---

## 検証方法

1. **ホバリング状態での検証** (`valcheck.py`)
   - PID制御でホバリング
   - 速度が0に近い状態での検証

2. **動的状態での検証** (`forward_quadrotor.py`)
   - チョン動作中の速度検証
   - 加速度が発生している状態での検証

---

## 検証結果

### 2026-01-23: 初回検証

#### ホバリング状態（valcheck.py）

**実行条件**:
- PID制御でホバリング（目標高さ2.0m）
- ログ間隔: 1秒ごと（240ステップごと）
- 安定化時間: 3秒

**結果**:
- ✅ **速度が正しく取得できている**
- PyBullet速度: `vel_x=0.00 cm/s, vel_y=0.00 cm/s`
- 位置変化から計算: `vel_x=0.00 cm/s, vel_y=0.00 cm/s`
- 速度の差: `Δvel_x=0.00 cm/s, Δvel_y=0.00 cm/s`
- **完全に一致**

**ログファイル**: `logs/valcheck.log`

**所感**:
- ホバリング状態（静止状態）では、PyBulletの速度取得と位置変化からの計算が完全に一致
- 速度が0に近い状態では問題なく動作している

---

#### 動的状態（forward_quadrotor.py - チョン中）

**実行条件**:
- チョン動作: `roll=1.719° × 5.0s`（減衰あり）
- 位置・速度PD: 有効
- ログ間隔: 1秒ごと（240ステップごと）

**結果**:
- ❌ **速度の不一致が大きい**

**t=4.00s（チョン開始1秒後）**:
- PyBullet速度(機体): `vel_x_body=14.16 cm/s, vel_y_body=-4.11 cm/s`
- 位置変化から計算(機体): `vel_x_body=2.18 cm/s, vel_y_body=9.92 cm/s`
- 速度の差: `Δvel_x_body=11.98 cm/s, Δvel_y_body=-14.03 cm/s`

**t=5.00s（チョン開始2秒後）**:
- PyBullet速度(機体): `vel_x_body=-0.74 cm/s, vel_y_body=-33.76 cm/s`
- 位置変化から計算(機体): `vel_x_body=3.40 cm/s, vel_y_body=8.07 cm/s`
- 速度の差: `Δvel_x_body=-4.14 cm/s, Δvel_y_body=-41.83 cm/s`

**t=8.00s（チョン終了時）**:
- PyBullet速度(機体): `vel_x_body=2.42 cm/s, vel_y_body=-74.11 cm/s`
- 位置変化から計算(機体): `vel_x_body=15.08 cm/s, vel_y_body=-2.82 cm/s`
- 速度の差: `Δvel_x_body=-12.66 cm/s, Δvel_y_body=-71.30 cm/s`

**ログファイル**: `logs/forward_quadrotor_velocity.log`

**所感**:
- 動的状態（加速度が発生している状態）では、PyBulletの速度取得と位置変化からの計算が大きく異なる
- 特にY方向の速度で大きな不一致（最大約71 cm/sの差）
- X方向の速度でも不一致が発生（最大約12 cm/sの差）
- 速度フィードバック制御（速度D）が正しく機能していない可能性が高い

---

## 重要な発見

### 1. 静止状態 vs 動的状態

- **静止状態（ホバリング）**: 速度が正しく取得できている ✅
- **動的状態（チョン中）**: 速度の不一致が大きい ❌

### 2. 問題の本質

- PyBulletの速度取得そのものは正しく動作している（静止状態で確認済み）
- 動的状態での速度取得と位置変化のタイミングに問題がある可能性
- 制御ループのタイミング（`controller.update()` → `apply_thrusts()` → `stepSimulation()`）との関係が疑われる

### 3. 制御への影響

- 速度フィードバック制御（速度D）が正しく機能していない可能性が高い
- 位置・速度PD制御の性能に大きな影響を与えている
- 速度が不正確だと、制御性能の改善は困難

---

### 2026-01-23: ピッチ前傾テスト（動的状態での速度検証）

#### 実行条件

- ピッチ前傾テスト: `t=5.0s`から`0.1s`間、`pitch=2.86°`
- ログ間隔: テスト中は0.1秒ごと（24ステップごと）、それ以外は1秒ごと
- 制御: なし（吹っ飛ぶ状態）

#### 速度の方向性（符号）の分析

**速度の方向（符号）の一致/不一致**:

| 時刻 | X方向（符号） | Y方向（符号） | 備考 |
|------|--------------|--------------|------|
| t=5.10s | ✅ 一致（両方正） | ❌ 不一致（PyBullet:正, 位置変化:負） | 初期 |
| t=5.20s | ✅ 一致（両方負） | ❌ 不一致（PyBullet:負, 位置変化:正） | 方向が逆 |
| t=5.30s | ✅ 一致（両方正） | ❌ 不一致（PyBullet:正, 位置変化:負） | 方向が逆 |
| t=5.40s | ✅ 一致（両方負） | ❌ 不一致（PyBullet:負, 位置変化:正） | 方向が逆 |
| t=5.50s | ✅ 一致（両方正） | ✅ 一致（両方正） | 方向一致 |
| t=5.60s | ❌ 不一致（PyBullet:負, 位置変化:正） | ✅ 一致（両方正） | X方向が逆 |
| t=5.70s | ✅ 一致（両方負） | ❌ 不一致（PyBullet:負, 位置変化:正） | Y方向が逆 |
| t=5.80s | ✅ 一致（両方負） | ✅ 一致（両方負） | 方向一致 |
| t=5.90s | ✅ 一致（両方負） | ✅ 一致（両方負） | 方向一致 |
| t=6.00s | ✅ 一致（両方負） | ✅ 一致（両方負） | 方向一致 |
| t=6.10s | ❌ 不一致（PyBullet:正, 位置変化:負） | ✅ 一致（両方負） | X方向が逆 |

**重要な発見**:

1. **速度の方向（符号）は一致しない場合が多い**
   - 特に初期（t=5.10s〜5.40s）: Y方向で方向が逆になることが多い
   - 後期（t=5.80s以降）: 方向が一致することが多い

2. **速度が大きい時ほど方向の不一致が発生**
   - t=5.20s〜5.40s: 速度が大きく、方向が逆になる
   - t=5.80s以降: 速度が小さくなり、方向が一致する

3. **X方向とY方向の違い**
   - X方向: 比較的方向が一致しやすい
   - Y方向: 方向が逆になることが多い（特に初期）

#### 速度の大きさの分析

**速度の差の推移**:

| 時刻 | X方向の差 | Y方向の差 | 速度の大きさ |
|------|----------|----------|------------|
| t=5.10s | 10.02 cm/s | 1.82 cm/s | 小さい |
| t=5.20s | -2.12 cm/s | -30.29 cm/s | 大きい（Y方向） |
| t=5.30s | -6.39 cm/s | 57.07 cm/s | 非常に大きい（Y方向） |
| t=5.40s | 2.42 cm/s | -36.77 cm/s | 大きい（Y方向） |
| t=5.50s | -2.73 cm/s | 8.78 cm/s | 中程度 |
| t=5.60s | -5.18 cm/s | -4.59 cm/s | 小さい |
| t=5.70s | -3.31 cm/s | -6.45 cm/s | 小さい |
| t=5.80s | -1.22 cm/s | -6.32 cm/s | 小さい |
| t=5.90s | 0.59 cm/s | -5.67 cm/s | 小さい |
| t=6.00s | 2.36 cm/s | -5.39 cm/s | 小さい |
| t=6.10s | 5.04 cm/s | -5.46 cm/s | 小さい |

**重要な発見**:

1. **速度が大きい時ほど差が大きい**
   - t=5.30s: Y方向で最大57 cm/sの差
   - t=5.20s, 5.40s: Y方向で約30〜37 cm/sの差

2. **速度が小さくなると差も小さくなる**
   - t=5.80s以降: 差が約1〜6 cm/sに縮小

3. **ユーザーの指摘通り**
   - ✅ **加速度の方向性（ベクトル）は合っている**（後期では方向が一致）
   - ✅ **速度が速すぎると、速度計測が実態に合わない**
   - ✅ **速度が下がると、速度計測が実態に近くなる**

#### 結論

**速度の方向（符号）は測定可能だが、速度が大きい時は方向が逆になることがある**

- **速度が小さい時**: 方向が一致し、速度の差も小さい
- **速度が大きい時**: 方向が逆になることがあり、速度の差も大きい
- **特にY方向**: 方向が逆になることが多い（初期）

これは、加速度が大きい状態での速度取得タイミングの問題、または制御ループとのタイミングのずれが原因と考えられます。

---

## 次のステップ

1. **動的状態での速度取得タイミングの検証**
   - 制御ループ内での速度取得タイミングを確認
   - `stepSimulation()`前後の速度の変化を確認

2. **加速度中の速度取得の検証**
   - 一定加速度での速度検証
   - 速度と位置の整合性を確認

3. **速度取得方法の改善**
   - タイミングの調整
   - 速度の平滑化や補正の検討
   - **速度が大きい時の方向の不一致を解決**

---

## 参考

- `valcheck.py`: ホバリング状態での速度検証スクリプト
- `forward_quadrotor.py`: チョン動作中の速度検証（既存のスクリプト）
- `logs/valcheck.log`: ホバリング状態のログ
- `logs/forward_quadrotor_velocity.log`: チョン動作中のログ

---

（このファイルは検証結果に合わせて随時更新）
