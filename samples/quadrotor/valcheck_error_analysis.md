# valcheck.logの誤差分析

## 問題の本質

ログに記録されている誤差は、**n-1とnのずれだけが原因ではありません**。

## 誤差の主な原因

### 1. ログ間隔の問題

**現在の実装**:
- `LOG_INTERVAL = 240`（1秒ごと、240ステップごと）
- 位置変化: `dx = state_n['x'] - prev_state_n_minus_1['x']`（1秒間の合計）
- 速度の平均: `(vel_n_minus_1 + vel_n) / 2`（2点のみの平均）

**問題点**:
- 位置変化は**1秒間（240ステップ）の合計**を計算している
- 速度の平均は**n-1とnの2点のみ**の平均を計算している
- 1秒間の間に、姿勢が大きく変化しているため、座標変換の影響が大きい

### 2. 姿勢変化の影響

**t=6.00sの例**:
- n-1の姿勢: r=81.86°, p=-23.58°, y=28.29°
- nの姿勢: r=82.36°, p=-23.52°, y=28.83°
- **1秒間で姿勢が変化している**

**影響**:
- 機体座標系での速度検証でも不一致が発生
- 位置変化を機体座標系に変換する際、nのyaw角度を使用しているが、1秒間の姿勢変化を考慮していない

### 3. 座標変換のタイミング

**現在の実装**（valcheck.py 行411-412）:
```python
dx_body = dx * cos_yaw_n + dy * sin_yaw_n
dy_body = -dx * sin_yaw_n + dy * cos_yaw_n
```

**問題点**:
- 位置変化（dx, dy）は**1秒間の合計**（ワールド座標系）
- 座標変換には**nのyaw角度のみ**を使用
- 1秒間の姿勢変化を考慮していない

### 4. 実際の誤差の例

**t=6.00s**:
- 位置変化: Δx=-0.03 cm, Δy=-0.15 cm（1秒間）
- 位置変化から計算した速度: vel_x=-0.03 cm/s, vel_y=-0.15 cm/s
- n-1とnの速度の平均: vel_x_avg=-6.50 cm/s, vel_y_avg=-36.93 cm/s
- **誤差**: Δvel_x=6.47 cm/s, Δvel_y=36.77 cm/s

**t=7.00s**:
- 位置変化: Δx=+1.10 cm, Δy=+0.36 cm（1秒間）
- 位置変化から計算した速度: vel_x=1.10 cm/s, vel_y=0.36 cm/s
- n-1とnの速度の平均: vel_x_avg=271.93 cm/s, vel_y_avg=96.40 cm/s
- **誤差**: Δvel_x=270.83 cm/s, Δvel_y=96.05 cm/s

## 結論

### 誤差の原因

1. **ログ間隔が長すぎる**（1秒間）
   - 位置変化は1秒間の合計を計算している
   - 速度の平均は2点のみの平均を計算している
   - 1秒間の間に、姿勢が大きく変化している

2. **姿勢変化の影響**
   - 1秒間で姿勢が大きく変化している
   - 座標変換の際、姿勢変化を考慮していない

3. **座標変換のタイミング**
   - 位置変化を機体座標系に変換する際、nのyaw角度のみを使用
   - 1秒間の姿勢変化を考慮していない

### 解決策

1. **ログ間隔を短くする**（例: 1ステップごと、または10ステップごと）
   - 位置変化と速度の平均を同じタイムステップで計算
   - 姿勢変化の影響を最小限に抑える

2. **姿勢変化を考慮した座標変換**
   - 1秒間の姿勢変化を考慮して、位置変化を機体座標系に変換
   - または、各ステップごとに座標変換を行い、合計を計算

3. **台形公式の適用範囲を明確にする**
   - 台形公式は「等間隔の2点間の平均速度」を計算する
   - 1秒間の位置変化と比較するには、1秒間の速度の積分が必要

## 検証方法

### 推奨される検証方法

1. **ログ間隔を1ステップに変更**
   ```python
   LOG_INTERVAL = 1  # 1ステップごと
   ```

2. **姿勢変化を考慮した検証**
   - 各ステップごとに座標変換を行い、合計を計算
   - または、姿勢変化を考慮した座標変換を実装

3. **速度の積分検証**
   - 1秒間の速度を積分して、位置変化と比較
   - Simpson法などの高精度な積分手法を使用

## 参考

- `valcheck.py`: 速度検証スクリプト
- `velocity_timing_analysis.md`: 速度取得タイミングの詳細分析
- `control_flow_sequence.md`: 制御フローのシーケンス図
