# forward_quadrotor 計測ログ

チョン1実験の条件・結果を記録し、前回比較できるようにする。

---

## 共通条件（いずれも）

- 1) ホバ 3.0s → 2) チョン1 → 3) ホバ 2.5s（CHON の値は Run ごと）
- 推力配分: `thrust_height_raw<0` で全0、else で roll/pitch スケールしてクリップによる吹き上がり防止
- CHON 中: height の integral 凍結、chon 終了時は `reset()` なし

---

## 重要なマイルストーン

### Run 2 — roll/pitch kd=10.0（D ショックアブソーバー強化）

| 項目 | 値 |
|------|-----|
| **roll_pid** | kp=10, ki=0.5, **kd=10.0** |
| **pitch_pid** | kp=10, ki=0.5, **kd=10.0** |

#### 結果

| 項目 | 値 |
|------|-----|
| Δx | +2.81 cm |
| Δy | -9.28 cm |
| Δz | -1.43 cm |

#### 所感

- Run 1（kd=5.0）と比較して、振動が大幅に減少（レンジ約39° → 約17°）
- t=5s で r≈0°, p≈-0.3° とほぼ水平
- **結論**: D を 5.0→10.0 に上げたことで、roll/pitch の振動が小さくなり、姿勢が安定した。

---

### Run 5 — 長時間チョン（5.0s）、位置・速度PD無効（開放系）

| 項目 | 値 |
|------|-----|
| **CHON_ROLL** | 0.03 rad（≒1.72°） |
| **CHON_DURATION** | **5.0 s**（長時間） |
| **roll_pid / pitch_pid** | kp=10, ki=0.5, kd=10.0 |
| **位置・速度PD** | **無効**（開放系チョン実験） |

#### 結果

| 項目 | 値 |
|------|-----|
| **Δx** | **+99.37 cm** |
| **Δy** | **-521.72 cm** |
| **Δz** | -1.43 cm |
| **[chon] 終了時の速度** | vel_x=19.67 cm/s, **vel_y=-105.93 cm/s** |
| **最終速度** | vel_x=24.08 cm/s, **vel_y=-108.97 cm/s** |

#### 所感

- **姿勢は立て直せているが、速度は残ったまま**（慣性ドリフト）
- チョン終了時に大きな水平速度（特に vel_y≈-106 cm/s）が発生
- 位置フィードバックがないため、hover_measure 中もその速度が維持され、大きなドリフトが発生
- **結論**: **課題2（慣性ドリフト）の対応（位置・速度PD）が急務**であることが明確になった。

---

### Run 23 — 位置P+速度D有効、Y方向の位置Pの符号修正

| 項目 | 値 |
|------|-----|
| **CHON_ROLL** | 0.03 rad（≒1.72°） |
| **CHON_DURATION** | **5.0 s** |
| **位置・速度PD** | **有効** |
| **KP_X** | 0.05 |
| **KD_X** | 0.3 |
| **KP_Y** | 0.05（**符号修正済み**） |
| **KD_Y** | 0.225 |
| **TARGET_X, TARGET_Y** | 0.0, 0.0（目標位置：原点） |
| **実装変更** | **Y方向の位置Pの符号を修正**（`pitch_offset += -self.kp_y * (self.target_y - y)`） |

#### 結果

| 項目 | 値 |
|------|-----|
| **Δx** | **+126.90 cm** |
| **Δy** | **-291.50 cm** |
| **Δz** | **-2.21 cm**（**良好**） |
| **[chon] 終了時の位置** | (x,y,z)=(41.77, 18.88, 2.05) cm |
| **[chon] 終了時の速度** | vel_x=19.67 cm/s, **vel_y=-105.93 cm/s** |
| **最終位置** | (x,y,z)=(126.90, 24.47, 2.033) cm,cm,m |
| **最終速度** | **vel_x=-68.46 cm/s, vel_y=140.33 cm/s** |
| **最終姿勢** | **(r,p,y)=(-8.87°, -13.64°, 14.02°)**（**大幅に改善**） |

#### 所感

- **Y方向の位置Pの符号修正により、Δx、vel_y、姿勢、高度が大幅に改善**
- しかし、**Δy = -291.50 cm**と大きい（Y方向の位置Pのゲイン調整が必要）
- **vel_y = 140.33 cm/s**とまだ大きい

---

### Run 25 — 現在の実装状態（位置・速度PD有効、Y方向の位置Pの符号修正済み）

| 項目 | 値 |
|------|-----|
| **CHON_ROLL** | 0.03 rad（≒1.72°） |
| **CHON_DURATION** | **5.0 s** |
| **位置・速度PD** | **有効** |
| **KP_X** | 0.05 |
| **KD_X** | 0.3 |
| **KP_Y** | 0.05（**符号修正済み**） |
| **KD_Y** | 0.225 |
| **TARGET_X, TARGET_Y** | 0.0, 0.0（目標位置：原点） |

#### 結果

| 項目 | 値 |
|------|-----|
| **Δx** | **+126.90 cm** |
| **Δy** | **-291.50 cm** |
| **Δz** | **-2.21 cm**（**良好**） |
| **最終位置** | (x,y,z)=(126.90, 24.47, 2.033) cm,cm,m |
| **最終速度** | vel_x=-68.46 cm/s, vel_y=140.33 cm/s |
| **最終姿勢** | (r,p,y)=(-8.87°, -13.64°, 14.02°) |

#### 所感

- Run 23と同じ結果（元に戻したため）
- **Δy = -291.50 cm**: まだ大きい（Y方向の位置Pのゲイン調整が必要）
- **vel_y = 140.33 cm/s**: まだ大きい

---

## Run 26 — 最新の実行結果（目標姿勢と実際の姿勢の比較）

| 項目 | 値 |
|------|-----|
| **CHON_ROLL** | 0.03 rad（≒1.72°） |
| **CHON_DURATION** | **5.0 s** |
| **位置・速度PD** | **有効** |
| **KP_X** | 0.05 |
| **KD_X** | 0.3 |
| **KP_Y** | 0.05 |
| **KD_Y** | 0.225 |
| **実装変更** | **デバッグログに目標roll/pitchを追加** |

### 結果

| 項目 | 値 |
|------|-----|
| **Δx** | **+126.90 cm** |
| **Δy** | **-291.50 cm** |
| **Δz** | **-2.21 cm** |
| **最終位置** | (x,y,z)=(126.90, 24.47, 2.033) cm,cm,m |
| **最終速度** | vel_x=-68.46 cm/s, vel_y=140.33 cm/s |
| **最終姿勢** | (r,p,y)=(-8.87°, -13.64°, 14.02°) |

### 重要な発見：目標姿勢と実際の姿勢の大きな差

デバッグログから判明した問題：

| 時刻 | 実際のroll | 目標roll | 差 | 実際のpitch | 目標pitch | 差 |
|------|-----------|----------|-----|-------------|-----------|-----|
| t=8.10s | 1.35° | **-4.83°** | **約6.18°** | 0.57° | **6.73°** | **約6.16°** |
| t=8.20s | 1.19° | **-5.25°** | **約6.44°** | 1.43° | **6.53°** | **約5.10°** |
| t=8.30s | 0.38° | **-5.86°** | **約6.24°** | 2.34° | **6.18°** | **約3.84°** |
| t=8.40s | -0.34° | **-6.59°** | **約6.25°** | 2.42° | **5.68°** | **約3.26°** |
| t=8.50s | -0.53° | **-7.40°** | **約6.87°** | 2.95° | **5.05°** | **約2.10°** |

### 問題の分析

1. **位置・速度PDは目標姿勢を生成している**:
   - 目標roll: -4.83° → -7.40°（X方向の位置誤差・速度から生成）
   - 目標pitch: 6.73° → 5.05°（Y方向の位置誤差・速度から生成）

2. **しかし、姿勢PIDが目標姿勢を追従できていない**:
   - 実際のroll: 1.35° → -0.53°（目標roll=-4.83°〜-7.40°に対して追従できていない）
   - 実際のpitch: 0.57° → 2.95°（目標pitch=6.73°〜5.05°に対して追従できていない）
   - **差が約3°〜7°と大きい**

3. **姿勢PIDのゲインが不十分な可能性**:
   - 現在の姿勢PID: `kp=10.0, ki=0.5, kd=10.0`
   - 目標姿勢の変化が大きい場合、追従できない可能性

### 次の対応事項

1. **姿勢PIDのゲインを上げる**: `kp`を10.0から15.0や20.0に上げる
2. **または、位置・速度PDのゲインを下げる**: 目標姿勢の変化を小さくする
3. **姿勢PIDの応答性を確認**: 目標姿勢の変化に対して、姿勢PIDがどの程度追従できているかを確認

---

## Run 31以降 — 座標系の修正（位置Pと速度Dを機体座標系に統一）

### 問題の発見

ログから、`vel_y`（ワールド座標系）と実際の位置変化が一致しない問題を発見：
- `t=9.00s`: `vel_y=-40.75 cm/s`（負の値、-Y方向）
- `t=9.00s`: `y=19.03 cm`
- `t=9.10s`: `y=19.03 cm`（**変化なし！**）
- `期待Δy=-3.40 cm`だが`Δy=+0.00 cm`

**原因**: yaw角度が約10.8°あるため、ワールド座標系の速度と機体の実際の移動方向が一致していない。

### Run 31 — 速度Dを機体座標系に変更

| 項目 | 値 |
|------|-----|
| **CHON_ROLL** | 0.03 rad（≒1.72°） |
| **CHON_DURATION** | **5.0 s** |
| **位置・速度PD** | **有効** |
| **KP_X** | 0.05 |
| **KD_X** | 0.3 |
| **KP_Y** | 0.05 |
| **KD_Y** | 0.225 |
| **実装変更** | **速度Dをワールド座標系から機体座標系に変更**（`vel_x_body, vel_y_body`を使用） |

#### 結果

| 項目 | 値 | 変化（Run 26比） |
|------|-----|------------------|
| **Δx** | **+98.85 cm** | **-22%改善**（126.90 → 98.85） |
| **Δy** | **+20.86 cm** | **大幅改善**（-291.50 → +20.86） |
| **Δz** | **-1.70 cm** | **改善**（-2.21 → -1.70） |
| **最終位置** | (x,y,z)=(98.85,20.86,2.038) cm,cm,m | |
| **最終速度** | vel_x=-29.38 cm/s, vel_y=71.68 cm/s | vel_x: **+57%改善**（-68.46 → -29.38）<br>vel_y: **+49%改善**（140.33 → 71.68） |
| **最終姿勢** | (r,p,y)=(-6.76°, -7.64°, 11.95°) | |

#### 所感

- **速度抑制は改善**: 最終vel_xが-68.46 → -29.38 cm/sに改善
- **しかし、Δxは改善したが、まだ大きい**: 98.85 cm
- **問題**: 位置Pと速度Dの座標系が不一致（位置Pはワールド座標系、速度Dは機体座標系）

---

### Run 32 — 位置Pと速度Dの両方を機体座標系に統一

| 項目 | 値 |
|------|-----|
| **CHON_ROLL** | 0.03 rad（≒1.72°） |
| **CHON_DURATION** | **5.0 s** |
| **位置・速度PD** | **有効** |
| **KP_X** | 0.05 |
| **KD_X** | 0.3 |
| **KP_Y** | 0.05 |
| **KD_Y** | 0.225 |
| **実装変更** | **位置Pと速度Dの両方を機体座標系に統一**<br>- 位置誤差を機体座標系に変換（`dx_body, dy_body`）<br>- 速度Dは機体座標系の速度を使用（`vel_x_body, vel_y_body`） |

#### 結果

| 項目 | 値 | 変化（Run 31比） | 変化（Run 26比） |
|------|-----|------------------|------------------|
| **Δx** | **+114.43 cm** | **+16%悪化** | **-10%改善** |
| **Δy** | **+20.24 cm** | ほぼ同じ | **大幅改善** |
| **Δz** | **-1.60 cm** | **改善** | **改善** |
| **最終位置** | (x,y,z)=(114.43,20.24,2.039) cm,cm,m | | |
| **最終速度** | vel_x=-0.43 cm/s, vel_y=40.59 cm/s | vel_x: **+99%改善**<br>vel_y: **+43%改善** | vel_x: **+99%改善**<br>vel_y: **+71%改善** |
| **最終姿勢** | (r,p,y)=(-6.30°, -5.44°, 11.59°) | | |
| **チョン終了時** | x=39.09 cm, vel_x=16.30 cm/s | 同じ | 同じ |

#### 重要な発見

1. **速度抑制は大幅に改善**:
   - 最終vel_x: -78.68 → -0.43 cm/s（**約99%改善、ほぼ0に近い**）
   - 最終vel_y: 57.66 → 40.59 cm/s（**約30%改善**）
   - 位置Pと速度Dの両方を機体座標系に統一したことで、速度抑制が効果的に働いている

2. **しかし、X方向の位置変化は悪化**:
   - Δx: 58.88 → 114.43 cm（**約94%悪化**）
   - 速度抑制は効果的に働いているが、**位置誤差の累積が大きい**

3. **姿勢PIDの追従性の問題**:
   - t=9.00s: 実際のroll=-0.92°, 目標roll=-4.26°（**差約3.3°**）
   - t=10.50s: 実際のpitch=-5.44°, 目標pitch=-14.18°（**差約8.7°**）
   - **姿勢PIDが目標姿勢を追従できていない**ため、位置誤差が累積している

#### 次の対応事項

1. **姿勢PIDのゲインを上げる**: `kp`を10.0から15.0や20.0に上げる（推奨）
2. **位置Pのゲインを上げる**: `kp_x`と`kp_y`を0.05から0.1や0.15に上げる
3. **姿勢PIDの応答性を確認**: 目標姿勢の変化に対して、姿勢PIDがどの程度追従できているかを確認

#### 所感

- **座標系の統一は成功**: 位置Pと速度Dの両方を機体座標系に統一したことで、速度抑制が大幅に改善
- **姿勢PIDの追従性が課題**: 目標姿勢と実際の姿勢の差が大きいため、位置誤差が累積している
- **次のステップ**: 姿勢PIDのゲインを上げるか、位置Pのゲインを調整することで、位置誤差の累積を防ぐ必要がある

---

## 検証ログの解析結果（Run 32実行後）

### 重要な発見

#### 1. X方向の座標変換式は正しい

| 時刻 | vel_body逆変換期待Δx | 実際のΔx | 差 |
|------|---------------------|---------|-----|
| t=9.10s | +3.78 cm | +3.67 cm | **-0.11 cm（ほぼ一致）** |
| t=9.20s | +3.98 cm | +3.89 cm | **-0.09 cm（ほぼ一致）** |
| t=9.30s | +4.15 cm | +4.08 cm | **-0.07 cm（ほぼ一致）** |

**結論**: X方向の座標変換式は**正しい**。機体座標系の速度から期待される位置変化と実際の位置変化が一致している。

#### 2. Y方向の座標変換式に問題がある可能性

| 時刻 | vel_body逆変換期待Δy | 実際のΔy | 差 |
|------|---------------------|---------|-----|
| t=9.10s | **-5.93 cm** | **+0.00 cm** | **+5.93 cm（大きな不一致）** |
| t=9.20s | **-5.55 cm** | **+0.03 cm** | **+5.58 cm（大きな不一致）** |
| t=9.30s | **-5.11 cm** | **-0.01 cm** | **+5.10 cm（大きな不一致）** |

**問題**: Y方向の座標変換式が**間違っている**可能性がある。または、Y方向の速度が正しく計算されていない。

#### 3. PyBullet速度の不安定性

PyBulletから取得した速度が大きく変動しているが、vel_body逆変換速度は比較的安定しており、実際の位置変化と一致している（X方向）。

### 問題の原因

Y方向の座標変換式の符号が間違っている可能性がある。X方向は一致しているため、変換式の基本構造は正しいが、Y方向の符号や計算に誤りがある可能性がある。

### 次のステップ

1. **Y方向の座標変換式を再確認**: 符号が間違っている可能性がある
2. **制御の影響を確認**: 位置・速度PDがY方向の速度にどのような影響を与えているか確認

---

詳細な試行錯誤ログは [`forward_quadrotor_log_archive.md`](./forward_quadrotor_log_archive.md) を参照してください。

---

（このファイルは `forward_quadrotor.py` の変更に合わせて随時更新）
